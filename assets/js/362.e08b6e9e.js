(window.webpackJsonp=window.webpackJsonp||[]).push([[362],{566:function(a,s,t){"use strict";t.r(s);var n=t(5),e=Object(n.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"certbot-dns-aliyun阿里云证书自动续期"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#certbot-dns-aliyun阿里云证书自动续期"}},[a._v("#")]),a._v(" certbot-dns-aliyun阿里云证书自动续期")]),a._v(" "),t("blockquote",[t("p",[a._v("解决阿里云 DNS 不能自动为通配符证书续期的问题")])]),a._v(" "),t("h2",{attrs:{id:"原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[a._v("#")]),a._v(" 原理")]),a._v(" "),t("p",[a._v("当我们使用 certbot 申请"),t("strong",[a._v("通配符")]),a._v("证书时，需要手动添加 TXT 记录。每个 certbot 申请的证书有效期为 3 个月，虽然 certbot 提供了自动续期命令，但是当我们把自动续期命令配置为定时任务时，我们无法手动添加新的 TXT 记录用于 certbot 验证。")]),a._v(" "),t("p",[a._v("好在 certbot 提供了一个 hook，可以编写一个 Shell 脚本。在续期的时候让脚本调用 DNS 服务商的 API 接口动态添加 TXT 记录，验证完成后再删除此记录。")]),a._v(" "),t("h2",{attrs:{id:"安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[a._v("#")]),a._v(" 安装")]),a._v(" "),t("ol",[t("li",[t("p",[a._v("安装 aliyun cli 工具")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("wget")]),a._v(" https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" xzvf aliyun-cli-linux-latest-amd64.tgz\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" aliyun /usr/local/bin\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" aliyun\n")])])]),t("p",[a._v("安装完成后需要配置"),t("a",{attrs:{href:"https://help.aliyun.com/document_detail/110341.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("凭证信息"),t("OutboundLink")],1)])]),a._v(" "),t("li",[t("p",[a._v("安装 certbot-dns-aliyun 插件")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("wget")]),a._v(" https://cdn.jsdelivr.net/gh/justjavac/certbot-dns-aliyun@main/alidns.sh\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" alidns.sh /usr/local/bin\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" +x /usr/local/bin/alidns.sh\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("ln")]),a._v(" -s /usr/local/bin/alidns.sh /usr/local/bin/alidns\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" alidns.sh\n")])])])]),a._v(" "),t("li",[t("p",[a._v("申请证书")]),a._v(" "),t("p",[a._v("测试是否能正确申请：")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("certbot certonly -d *.frunoob.cn --manual --preferred-challenges dns --manual-auth-hook "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"alidns"')]),a._v(" --manual-cleanup-hook "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"alidns clean"')]),a._v(" --dry-run\n")])])]),t("p",[a._v("正式申请时去掉 "),t("code",[a._v("--dry-run")]),a._v(" 参数：")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("certbot certonly -d *.frunoob.cn --manual --preferred-challenges dns --manual-auth-hook "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"alidns"')]),a._v(" --manual-cleanup-hook "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"alidns clean"')]),a._v("\n")])])])])]),a._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[a._v("提示")]),a._v(" "),t("p",[a._v("新版的certbot内置了定时器，会自动续期，后面步骤不需要执行了")])]),a._v(" "),t("ol",{attrs:{start:"4"}},[t("li",[t("p",[a._v("证书续期")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[a._v("certbot renew --manual --preferred-challenges dns --manual-auth-hook "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"alidns"')]),a._v(" --manual-cleanup-hook "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"alidns clean"')]),a._v(" --dry-run\n")])])]),t("p",[a._v("如果以上命令没有错误，把 "),t("code",[a._v("--dry-run")]),a._v(" 参数去掉。")])]),a._v(" "),t("li",[t("p",[a._v("自动续期")]),a._v(" "),t("p",[a._v("添加定时任务 crontab。")]),a._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("crontab")]),a._v(" -e\n")])])]),t("p",[a._v("输入")]),a._v(" "),t("div",{staticClass:"language-txt extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('1 1 */1 * * root certbot renew --manual --preferred-challenges dns --manual-auth-hook "alidns" --manual-cleanup-hook "alidns clean" --deploy-hook "nginx -s reload"\n')])])]),t("p",[a._v("上面脚本中的 "),t("code",[a._v('--deploy-hook "nginx -s reload"')]),a._v(" 表示在续期成功后自动重启 nginx。")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);