(window.webpackJsonp=window.webpackJsonp||[]).push([[332],{535:function(a,t,s){"use strict";s.r(t);var n=s(5),e=Object(n.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"mysql-备份-windows平台"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql-备份-windows平台"}},[a._v("#")]),a._v(" mysql|备份|windows平台")]),a._v(" "),s("h2",{attrs:{id:"mysql自动备份到远程服务器-冷备份"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql自动备份到远程服务器-冷备份"}},[a._v("#")]),a._v(" mysql自动备份到远程服务器|冷备份")]),a._v(" "),s("p",[a._v("先备份到本地服务器")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('@echo off\n@chcp 936\nset NAMES=utf8\nset hour=%time:~0,2%\nif "%time:~0,1%"==" " set hour=0%time:~1,1%\nset now=%date:~0,4%%date:~5,2%%date:~8,2%%hour%%time:~3,2%%time:~6,2%\nif "%1"=="" echo "please input database name, using comman like  (mysqlbackup.cmd <database>)" \nif "%1"=="" goto:EOF\nset database=%1\nset outFileName=%database%_%now%.sql\nmysqldump -q -u root --password=root  -r D:\\auto_backup\\mysql\\%outFileName%  %database%\n\n')])])]),s("p",[a._v("通过工具openssh使用SSH协议安全传输文件")]),a._v(" "),s("p",[a._v("工具下载网址 https://github.com/PowerShell/Win32-OpenSSH")]),a._v(" "),s("p",[a._v("安装工具之后会在计算机的防火墙中添加一个规则， "),s("code",[a._v("OpenSSH-Server-In-TCP")]),a._v(",此规则将允许放开端口22.")]),a._v(" "),s("p",[a._v("需要开放端口 配置ssh密钥  对于ssh服务器端有window版本限制 操作过于繁琐 考虑到一般在局域网中进行备份所以改用ftp协议作为文件传输的的新方式")]),a._v(" "),s("p",[a._v("ftp是window自带的功能，直接在window功能中添加即可\n在window下创建ftp服务器教程  https://zhuanlan.zhihu.com/p/411646279")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('@echo off\n@chcp 936\n\n\n@rem backup  destination\nset ftpip=192.168.8.84\nset ftp_name=ftpuser\nset ftp_pwd=ftpuser\nset ftp_path=.\\auto_backup\\mysql\\\nset ftp_local_dir=D:\\auto_backup\\mysql\\\n\n\n\nset NAMES=utf8\nset hour=%time:~0,2%\nif "%time:~0,1%"==" " set hour=0%time:~1,1%\nset now=%date:~0,4%%date:~5,2%%date:~8,2%%hour%%time:~3,2%%time:~6,2%\nif "%1"=="" echo "please input database name, using comman like  (mysqlbackup.cmd <database>)" \nif "%1"=="" goto:EOF\nset database=%1\nset outFileName=%database%_%now%.sql\nmysqldump -q -u root --password=root  -r %ftp_local_dir%%outFileName%  %database%\n\necho open %ftpip% >ftp.up\necho %ftp_name%>>ftp.up\necho %ftp_pwd%>>ftp.up\necho cd %ftp_path% >> ftp.up\necho binary>>ftp.up\necho mput %ftp_local_dir%%database%*.sql >>ftp.up\necho bye>>ftp.up\nftp -s:ftp.up\ndel ftp.up /q\n@rem pause\n')])])]),s("p",[a._v("备份文件的管理，自动清理多余备份")]),a._v(" "),s("p",[a._v("!n! 和setlocal enabledelayedexpansion搭配使用，批处理命令按行处理，最先进行的是变量的赋值，即将%x%替换成明确的值，然后在执行语句")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('pushd %ftp_local_dir%\nsetlocal enabledelayedexpansion\nset n=0\nfor /f "delims=" %%a in (\'dir /a-d-h /b /o-d %database%*.sql\') do (\nif !n! geq 7  del "%%~a"\nset /a n+=1 \n)\npopd\n')])])]),s("p",[a._v("最终完整版本")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('@echo off\n@chcp 936\n\n\n@rem backup  destination\nset ftpip=192.168.8.84\nset ftp_name=ftpuser\nset ftp_pwd=ftpuser\nset ftp_path=.\\auto_backup\\mysql\\\nset ftp_local_dir=D:\\auto_backup\\mysql\\\n\n\n\nset NAMES=utf8\nset hour=%time:~0,2%\nif "%time:~0,1%"==" " set hour=0%time:~1,1%\nset now=%date:~0,4%%date:~5,2%%date:~8,2%%hour%%time:~3,2%%time:~6,2%\nif "%1"=="" echo "please input database name, using comman like  (mysqlbackup.cmd <database>)" \nif "%1"=="" goto:EOF\nset database=%1\nset outFileName=%database%_%now%.sql\nmysqldump -q -u root --password=root  -r %ftp_local_dir%%outFileName%  %database%\n\n\npushd %ftp_local_dir%\nsetlocal enabledelayedexpansion\nset n=0\nfor /f "delims=" %%a in (\'dir /a-d-h /b /o-d %database%*.sql\') do (\nif !n! geq 7  del "%%~a"\nset /a n+=1 \n)\npopd\n\necho open %ftpip% >ftp.up\necho %ftp_name%>>ftp.up\necho %ftp_pwd%>>ftp.up\necho cd %ftp_path% >> ftp.up\necho prompt yes >> ftp.up\necho mdelete  %database%*.sql >> ftp.up\necho binary>>ftp.up\necho mput %ftp_local_dir%%database%*.sql >>ftp.up\necho bye>>ftp.up\nftp -s:ftp.up\ndel ftp.up /q\npause\n')])])]),s("p",[a._v("后记，windowftp服务器搭建以及计划任务程序注意事项")]),a._v(" "),s("p",[a._v("添加Ftp功能: 启用或关闭windows功能-internet information services-FTP服务器 + web管理工具\n添加用户: windows管理工具-计算机管理-本地用户和组-用户（右击-新用户）：用户名ftpuser 密码： ftpuser 仅勾选用户不能更改密码和密码永不过期 其余不要勾选\n建站： 管理工具-Internet Information Services (IIS)管理器\n网站（右击）：添加ftp服务器-规定物理路径 (随意)")]),a._v(" "),s("p",[a._v("数据库所在服务器要手动创建文件夹D:\\auto_backup\\mysql\\")]),a._v(" "),s("p",[a._v("计划任务  taskschd.msc")]),a._v(" "),s("p",[a._v("服务  service.msc")]),a._v(" "),s("p",[a._v("计算机管理  compmgmt.msc")]),a._v(" "),s("h2",{attrs:{id:"热备份-xtrabackup-wsl-linux-window子系统"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#热备份-xtrabackup-wsl-linux-window子系统"}},[a._v("#")]),a._v(" 热备份|xtrabackup|wsl|linux|window子系统")]),a._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[a._v("参考自")]),a._v(" "),s("p",[s("a",{attrs:{href:"https://www.percona.com/blog/percona-xtrabackup-for-windows/",target:"_blank",rel:"noopener noreferrer"}},[a._v("Percona XtraBackup for Windows"),s("OutboundLink")],1)]),a._v(" "),s("p",[s("a",{attrs:{href:"http://patg.net/mysql,windows/10,wsl,backups/2017/09/03/xtrabackup-wsl/",target:"_blank",rel:"noopener noreferrer"}},[a._v("使用 WSL 在 Windows 上运行 XtraBackup"),s("OutboundLink")],1)]),a._v(" "),s("p",[s("a",{attrs:{href:"https://docs.percona.com/percona-xtrabackup/2.4/backup_scenarios/incremental_backup.html#creating-an-incremental-backup",target:"_blank",rel:"noopener noreferrer"}},[a._v("Incremental Backup"),s("OutboundLink")],1)]),a._v(" "),s("p",[s("a",{attrs:{href:"https://forums.percona.com/t/problem-with-running-xtrabackup-24-in-debian-with-wsl2/14252/14",target:"_blank",rel:"noopener noreferrer"}},[a._v("Problem with running xtrabackup 24 in debian with WSL2"),s("OutboundLink")],1)]),a._v(" "),s("p",[s("a",{attrs:{href:"https://blog.csdn.net/qq_26614295/article/details/81502338",target:"_blank",rel:"noopener noreferrer"}},[a._v("Linux修改open files数及ulimit和file-max的区别"),s("OutboundLink")],1)]),a._v(" "),s("p",[a._v("https://learn.microsoft.com/zh-cn/powershell/module/microsoft.powershell.core/about/about_environment_variables?view=powershell-7.4")])]),a._v(" "),s("p",[a._v("生产环境无法进行完整备份，因为数据库24小时都在周期性高强度运行，备份严重影响了系统的稳定性。")]),a._v(" "),s("p",[a._v("xtrabackup的优点：热备份 ，详细的看官网介绍吧")]),a._v(" "),s("p",[a._v("本地测试，搭建环境")]),a._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[a._v("环境")]),a._v(" "),s("p",[a._v("windows server 2019   version: 1809")]),a._v(" "),s("p",[a._v("数据库 mysql 5.7.38")])]),a._v(" "),s("ol",[s("li",[a._v("安装WSL（windows subsystem linux）,用于执行xtrabackup。")])]),a._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[a._v("参考教程")]),a._v(" "),s("p",[a._v("由于window版本少于1904 所以只能使用旧版WSL的手动安装方法，无法安装WSL 2，所以参考以下教程")]),a._v(" "),s("p",[a._v("https://learn.microsoft.com/zh-cn/windows/wsl/install-manual#step-1---enable-the-windows-subsystem-for-linux")])]),a._v(" "),s("div",{staticClass:"language-powershell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-powershell"}},[s("code",[a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 启用WSL功能")]),a._v("\ndism"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("exe "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("online "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("enable-feature")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("featurename:Microsoft"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("Windows"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("Subsystem"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("Linux "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("all "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("norestart\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 装所选的 Linux 分发")]),a._v("\n\ncurl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("exe "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("L "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("o ubuntu"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("2004"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("appx https:"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("aka"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("ms"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("wslubuntu2004\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 安装linux")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("Add-AppxPackage")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("\\ubuntu"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("2004"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("appx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 最后必须要手动点开开始菜单里刚安装上的ubuntu，等待它完成初始化之后，才能在powershell通过执行`bash`命令来随时随地进入linux系统")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 但是如果是通过ssh连接的window，无法手动点击开始菜单里的应用，那么只能通过powershell来启动windows的内置应用了。")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("Get-Package")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#该命令只能展示第三方应用")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 因为ubuntu属于universal windows app（UWP），因为windows自身限制所以很难直接找到其安装目录，所以可以通过以下命令获取到全部的UWP应用信息")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("PS")]),a._v(" C:\\Users\\fqq> "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("Get-AppxPackage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("|")]),a._v(" findstr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("exe "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("n "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Ubuntu"')]),a._v("\n507:Name              : CanonicalGroupLimited"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("UbuntuonWindows\n512:PackageFullName   : CanonicalGroupLimited"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("UbuntuonWindows_2004"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("2021"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("825"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("0_x64__79rhkp1fndgsc\n513:InstallLocation   : C:\\Program Files\\WindowsApps\\CanonicalGroupLimited"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("UbuntuonWindows_2004"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("2021"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("825"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("0_x64__79rhkp1fndg\n516:PackageFamilyName : CanonicalGroupLimited"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("UbuntuonWindows_79rhkp1fndgsc\n522:Dependencies      : "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("CanonicalGroupLimited"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("UbuntuonWindows_2004"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("2021"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("825"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("0_neutral_split"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("scale"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("150_79rhkp1fndgsc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" Canon\n523:                    icalGroupLimited"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("UbuntuonWindows_2004"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("2021"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("825"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("0_neutral_split"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("scale"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("100_79rhkp1fndgsc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" CanonicalGr\n524:                    oupLimited"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("UbuntuonWindows_2004"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("2021"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("825"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("0_neutral_split"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("scale"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),a._v("125_79rhkp1fndgsc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 通过以上命令可以得到ubuntu应用的name和PackageFamilyName，当然还有installLocation，但是该地址是无法访问的，紧接着，我们要启动它该如何做呢，通过简单的查找来直接启动")]),a._v("\nexplorer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("exe shell:appsFolder\\<PackageFamilyName>"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("ubuntu "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 只需要把PackageFamilyName替换成你刚刚查询出来的即可")]),a._v("\n\nexplorer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("exe shell:appsFolder\\CanonicalGroupLimited"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("UbuntuonWindows_79rhkp1fndgsc"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("ubuntu\n\n\n")])])]),s("h2",{attrs:{id:"等一会之后-在命令行中执行bash即可进入ubuntu"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#等一会之后-在命令行中执行bash即可进入ubuntu"}},[a._v("#")]),a._v(" 等一会之后，在命令行中执行bash即可进入ubuntu")]),a._v(" "),s("div",{staticClass:"custom-block danger"},[s("p",{staticClass:"custom-block-title"},[a._v("如果bash命令无效说明ubuntu没有安装完成")]),a._v(" "),s("p",[a._v("可能是当前登录windows的账户和登录ssh的账户不是同一个，所以无法通过命令行打开图形化界面所以就无法完成ubuntu的安装。\n所以只能手动执行ubuntu.exe执行文件，但是该文件受windows保护无法执行，最终参考"),s("a",{attrs:{href:"https://github.com/microsoft/WSL/discussions/2323",target:"_blank",rel:"noopener noreferrer"}},[a._v("retoch的评论解决了该问题"),s("OutboundLink")],1)]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("I have solved the issue for me. I noticed that unbuntu.exe in the path\nC:\\Users\\<username>\\AppData\\Local\\Microsoft\\WindowsApps\\ was 0kb and had no icon.\n\nI copied everything from:\nC:\\Program Files\\WindowsApps\\CanonicalGroupLimited.UbuntuonWindows_1604.2017.922.0_x64__79rhkp1fndgsc\nInto:\nC:\\Users\\<username>\\AppData\\Local\\Microsoft\\WindowsApps\\CanonicalGroupLimited.UbuntuonWindows_79rhkp1fndgsc\n\nRan unbuntu.exe from inside the Canonical... folder in the user AppData dir, and everything installed perfectly.\n")])])])]),a._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[a._v("如何使用root自动进入WSL")]),a._v(" "),s("p",[a._v("完成ubuntu安装的过程中，会让创建新的用户和密码，但是不想执行命令时时候还要输入密码，想要以root身份自动进入到WSL中，该怎么做呢，")]),a._v(" "),s("p",[a._v("进入到包含 ubuntu.exe 的目录 ，  参考上面"),s("code",[a._v("如果bash命令无效说明ubuntu没有安装完成")]),a._v("这里的目录，执行一下命令")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v(" .\\ubuntu.exe  config --default-user root\n")])])]),s("p",[a._v("大功告成，以后执行bash  就可以 以root身份直接进入到wsl中了")])]),a._v(" "),s("h2",{attrs:{id:"安装xtrabackup"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装xtrabackup"}},[a._v("#")]),a._v(" 安装xtrabackup")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("apt-get update\napt-get install lsb\nwget https://repo.percona.com/apt/percona-release_latest.$(lsb_release -sc)_all.deb\nsudo dpkg -i percona-release_latest.$(lsb_release -sc)_all.deb\npercona-release enable-only tools\napt-get update\napt install percona-xtrabackup-24\napt install qpress\n\n")])])]),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[a._v("怎么卸载？")]),a._v(" "),s("p",[s("code",[a._v("sudo apt remove percona-xtrabackup-24")])])]),a._v(" "),s("h2",{attrs:{id:"进行全备份"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#进行全备份"}},[a._v("#")]),a._v(" 进行全备份")]),a._v(" "),s("p",[a._v("创建一个配置文件，名为"),s("code",[a._v("my.ini")]),a._v(",放在windows的E:/jordanDatabaseBackup目录下，其挂载在linux子系统的"),s("code",[a._v("/mnt/e/jordanDatabaseBackup")]),a._v("目录上，即"),s("code",[a._v("E:/")]),a._v("="),s("code",[a._v("/mnt/e/")])]),a._v(" "),s("p",[a._v("编辑文件，添加一下内容")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('[mysqld]\ndatadir  ="/mnt/e/BtSoft/mysql/MySQL5.7/data/"\ninnodb_data_home_dir = "/mnt/e/BtSoft/mysql/MySQL5.7/data/"\n\n')])])]),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v(" xtrabackup --defaults-file"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/mnt/e/jordanDatabaseBackup/my.ini   --backup  \n --password"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("JMDFCunsUm2Kpvxc --user"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("root --host"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".186.140 --port"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3306")]),a._v(" \n --target-dir"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/mnt/e/jordanDatabaseBackup/base \n\n")])])]),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[a._v("'datadir'配置错误")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("Warning: MySQL variable 'datadir' points to nonexistent directory 'E:\\BtSoft\\mysql\\MySQL5.7\\data\\'\nWarning: option 'datadir' has different values:\n  '/mnt/e/BtSoft/mysql/MySQL5.7/data/' in defaults file\n  'E:\\BtSoft\\mysql\\MySQL5.7\\data\\' in SHOW VARIABLES\n")])])]),s("p",[a._v("通过查询mysql5.7文档得知，"),s("code",[a._v("innodb_undo_directory")]),a._v("如果不设置的话，默认值是  数据文件夹下，即 服务器端配置文件"),s("code",[a._v("my.ini")]),a._v("的"),s("code",[a._v("datadir")]),a._v("参数。\nThe innodb_undo_directory variable defines the location of undo tablespace files. If the\ninnodb_undo_directory variable is undefined, undo tablespaces reside in the data directory.")]),a._v(" "),s("p",[a._v("所以为了能让linux下找到该目录，我们需要在"),s("code",[a._v("/mnt/e/jordanDatabaseBackup/my.ini")]),a._v("中再增加一行")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('[mysqld]\ndatadir  ="/mnt/e/BtSoft/mysql/MySQL5.7/data/"\ninnodb_data_home_dir = "/mnt/e/BtSoft/mysql/MySQL5.7/data/"\ninnodb_undo_directory = "/mnt/e/BtSoft/mysql/MySQL5.7/data/"\n\n')])])])]),a._v(" "),s("div",{staticClass:"custom-block danger"},[s("p",{staticClass:"custom-block-title"},[a._v("World-writable config file error")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("\nxtrabackup: [Warning] World-writable config file '/mnt/f/jordanDatabaseBackup/my.ini' is ignored.\nxtrabackup: recognized server arguments: --parallel=4\nxtrabackup: [Warning] World-writable config file '/mnt/f/jordanDatabaseBackup/my.ini' is ignored.\n")])])]),s("p",[a._v("my.ini配置文件所有人都可以修改不安全，修改一下访问权限就可以了")])]),a._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[a._v("Too many open files")]),a._v(" "),s("p",[a._v("1.修改file-max")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('# echo  6553560 > /proc/sys/fs/file-max  //sysctl -w "fs.file-max=34166"，前面2种重启机器后会恢复为默认值\nvim /etc/sysctl.conf, 加入以下内容，重启生效\n \nfs.file-max = 6553560\n')])])]),s("p",[a._v("2.修改ulimit的open file，系统默认的ulimit对文件打开数量的限制是1024")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("# ulimit -HSn 102400  //这只是在当前终端有效，退出之后，open files又变为默认值。当然也可以写到/etc/profile中，因为每次登录终端时，都会自动执行/etc/profile\n或\n# vim /etc/security/limits.conf  //加入以下配置，重启即可生效\n* soft nofile 65535 \n* hard nofile 65535\n")])])])]),a._v(" "),s("h2",{attrs:{id:"进行增量备份-必须有全备份才行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#进行增量备份-必须有全备份才行"}},[a._v("#")]),a._v(" 进行增量备份（必须有全备份才行）")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("xtrabackup --defaults-file=/mnt/e/jordanDatabaseBackup/my.ini   --backup   --parallel=4 --password=JMDFCunsUm2Kpvxc --user=root --host=192.168.186.140 --port=3306  --target-dir=/mnt/e/jordanDatabaseBackup/inc1  --incremental-basedir=/mnt/e/jordanDatabaseBackup/base\n\n")])])]),s("h2",{attrs:{id:"为还原数据做准备"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#为还原数据做准备"}},[a._v("#")]),a._v(" 为还原数据做准备")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("# To prepare the base backup\nxtrabackup --defaults-file=/mnt/e/jordanDatabaseBackup/my.ini --prepare  --apply-log-only --parallel=4 --password=JMDFCunsUm2Kpvxc --user=root --host=192.168.186.140 --port=3306 --target-dir=/mnt/e/jordanDatabaseBackup/base\n\n# 将第一个增量备份应用到完整备份（如果是最后一个增量备份 就不需要使用--apply-log-only参数）\nxtrabackup --defaults-file=/mnt/e/jordanDatabaseBackup/my.ini --prepare  --apply-log-only --parallel=4 --password=JMDFCunsUm2Kpvxc --user=root --host=192.168.186.140 --port=3306 --target-dir=/mnt/e/jordanDatabaseBackup/base --incremental-dir=/mnt/e/jordanDatabaseBackup/inc1\n\n\n")])])]),s("h2",{attrs:{id:"开始还原备份"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开始还原备份"}},[a._v("#")]),a._v(" 开始还原备份")]),a._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[a._v("警告")]),a._v(" "),s("p",[a._v("在还原备份之前，需要准备备份。")])]),a._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[a._v("还原到任意服务器")]),a._v(" "),s("p",[a._v("您可以在任何计算机上运行准备操作;它不需要位于原始服务器或要还原到的服务器上。您可以将备份复制到实用程序服务器并在那里进行准备。")]),a._v(" "),s("p",[a._v("但需要注意的是 ，如果要在别的服务器上还原的话，最好是纯净版的mysql，卸载重新安装，不然会出现无法启动mysql服务器的情况")]),a._v(" "),s("p",[a._v("如果使用宝塔面板安装的mysql 在设置root密码的时候要设置的和备份mysql 的root密码一致。否则无法登录到mysql")])]),a._v(" "),s("div",{staticClass:"custom-block danger"},[s("p",{staticClass:"custom-block-title"},[a._v("开始前必须清空datadir")]),a._v(" "),s("p",[a._v("要将 mysql的data目录清空，   "),s("code",[a._v("/path/to/mysql/data/")]),a._v("里面不能有东西")]),a._v(" "),s("p",[a._v("在执行还原之前，需要关闭MySQL服务器。您无法还原到正在运行的 mysqld 实例（导入部分备份时除外）")])]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("xtrabackup --defaults-file=/mnt/e/jordanDatabaseBackup/my.ini  --copy-back --parallel=2 --password=JMDFCunsUm2Kpvxc --user=root --host=192.168.186.140 --port=3306 --target-dir=/mnt/e/jordanDatabaseBackup/base\n\n\n")])])]),s("h2",{attrs:{id:"压缩备份-便于传输"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#压缩备份-便于传输"}},[a._v("#")]),a._v(" 压缩备份，便于传输")]),a._v(" "),s("p",[a._v("有时候，想要将备份文件放到远程服务器上，为了更快的传输文件，可以再备份的过程中压缩文件，既节省了空间又能节省传输流量，加快传输速度")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("# 压缩\nxtrabackup --backup --compress --compress-threads=4 --target-dir=/data/compressed/\n\n# 如果想要更小，可以使用压缩工具进一步压缩，即时间换空间。\n这里使用7za\n#安装工具\napt install p7zip-full  \n# 使用方法 参考以下链接\n参考[7za](https://frunoob.github.io/list/20220507141201.html#_7za)\n\n\n# 解压 （不保留源文件）\nxtrabackup --decompress --remove-original --target-dir=/data/compressed/\n\n")])])]),s("h2",{attrs:{id:"运维"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#运维"}},[a._v("#")]),a._v(" 运维")]),a._v(" "),s("p",[a._v("写个脚本，把脚本添加到crontab自动任务，每天执行一次，流程如下：")]),a._v(" "),s("p",[s("strong",[a._v("首先创建全备份")])]),a._v(" "),s("p",[s("code",[a._v("xtrabackup --defaults-file=/mnt/f/jordanDatabaseBackup/my.ini --backup --password=4123fgadfsdfasfasdfasf --user=root --host=127.0.0.1 --port=3306 --parallel=4 --target-dir=/mnt/f/jordanDatabaseBackup/base")])]),a._v(" "),s("p",[a._v("紧接着创建第一次增量备份")]),a._v(" "),s("p",[s("code",[a._v('xtrabackup --defaults-file=/mnt/f/jordanDatabaseBackup/my.ini --backup --password=4123fgadfsdfasfasdfasf --user=root --host=127.0.0.1 --port=3306 --parallel=4 --target-dir=/mnt/f/jordanDatabaseBackup/incr/$(date "+%Y-%m-%d") --incremental-basedir=/mnt/f/jordanDatabaseBackup/base')])]),a._v(" "),s("p",[s("strong",[a._v("以上是基础备份，为之后每天自动增量备份做准备, 接下来是每天执行一次的备份脚本")])]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('ulimit -HSn 102400\necho  6553560 > /proc/sys/fs/file-max \nxtrabackup --defaults-file=/mnt/f/jordanDatabaseBackup/my.ini   --backup --password=4123fgadfsdfasfasdfasf --user=root --host=127.0.0.1 --port=3306 --parallel=4 --target-dir=/mnt/f/jordanDatabaseBackup/incr/$(date "+%Y-%m-%d") --incremental-basedir=/mnt/f/jordanDatabaseBackup/incr/$(date "+%Y-%m-%d" -d "1 day ago")\n\n')])])]),s("p",[a._v("增量备份文件都放到了"),s("code",[a._v("incr")]),a._v("下，并以日期命名了。")]),a._v(" "),s("p",[s("strong",[a._v("定时任务")])]),a._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[a._v("关于WSL自动关机")]),a._v(" "),s("p",[a._v("参考"),s("a",{attrs:{href:"https://learn.microsoft.com/en-us/windows/wsl/faq",target:"_blank",rel:"noopener noreferrer"}},[a._v("FAQ"),s("OutboundLink")],1)]),a._v(" "),s("p",[a._v("如果没有通过bash访问WSL，windows会自动关闭WSL并清理资源，所以要一直保持SSH连接才能保证WSL服务一直运行。")]),a._v(" "),s("p",[a._v("所以定时任务是在bash保持打开的前提下实现的，如果没法一直保持bash，可以写powershell脚本，在windows里定时启动WSL，进入linux，执行sh脚本。")])]),a._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[a._v("关于crontab配置文件")]),a._v(" "),s("p",[a._v("最好别在这里写脚本，而是执行脚本文件，以防脚本执行异常或者日志无法存储等问题")])]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("# 为当前用户创建定时任务\n#进入到当前用户的crontab配置文件以添加定时任务\ncrontab -e\n# 在打开的文件中添加定时任务（每天执行一次）,\n10 0 * * * bash /path/to/auto.sh\n\n")])])]),s("p",[s("strong",[a._v("将定时任务的结果以邮件的形式发发送给自己")])]),a._v(" "),s("p",[a._v("获取qq邮箱的的授权码，百度一下，很多教程")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('# 安装依赖\napt-get install ssmtp\napt-get install mailutils\n\n# 修改配置文件\n\n nano /etc/ssmtp/ssmtp.conf\n\n                                      root=frunoob@qq.com\n                                      mailhub=smtp.qq.com:465\n                                      AuthUser=frunoob@qq.com\n                                      AuthPass=asfasdfasfasf\n                                      hostname=ffff\n                                      UseTLS=Yes\n                                       \n\n\nnano /etc/ssmtp/revaliases\n\n\t\t\t\t\t\t\troot:frunoob@qq.com:smtp.qq.com:465\n\n\n# 测试 如果上一条命令执行成功就发送邮件给frunoob@qq.com (text.txt代表邮件的内容)\n\n这里写要执行的命令，如果执行过程中没有出错就发送成功的消息，出错了由crontab自动发送错误信息（前提是需要在crontab  -e 编辑文件时配置好 MAILTO=example@mail.com）\nif [ $? -eq 0 ]; then\nmail -s "邮件主题" frunoob@qq.com < test.txt    \nfi\n\n')])])])])}),[],!1,null,null,null);t.default=e.exports}}]);